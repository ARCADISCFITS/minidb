{"version":3,"sources":["../src/persistent-object.js"],"names":[],"mappings":"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","file":"persistent-object.js","sourcesContent":["import {format} from 'util';\nimport Mixin from 'mixmatch';\n\nconst models = [];\n\nexport default class PersistentObject extends Mixin {\n  get db() {\n    return this._db;\n  }\n\n  get rowID() {\n    return this._rowID;\n  }\n\n  initializePersistentObject(db, attributes) {\n    this._db = db;\n    this.updateFromDatabaseAttributes(attributes || {});\n\n    return this;\n  }\n\n  static async findFirst(ModelClass, db, attributes) {\n    const row = await db.findFirstByAttributes(ModelClass.tableName, null, attributes);\n\n    if (row) {\n      const instance = new ModelClass();\n\n      instance.initializePersistentObject(db, row);\n\n      return instance;\n    }\n\n    return null;\n  }\n\n  static async findAll(ModelClass, db, attributes, orderBy) {\n    const rows = await db.findAllByAttributes(ModelClass.tableName, null, attributes, orderBy);\n\n    return rows.map((row) => {\n      const instance = new ModelClass();\n\n      instance.initializePersistentObject(db, row);\n\n      return instance;\n    });\n  }\n\n  static async findOrCreate(ModelClass, db, attributes) {\n    const row = await db.findFirstByAttributes(ModelClass.tableName, null, attributes);\n\n    const instance = new ModelClass();\n\n    instance.initializePersistentObject(db, row || attributes);\n\n    return instance;\n  }\n\n  static create(ModelClass, db, attributes) {\n    const instance = new ModelClass();\n\n    instance.initializePersistentObject(db, attributes);\n\n    return instance;\n  }\n\n  static async count(ModelClass, db, attributes) {\n    const result = await db.findFirstByAttributes(ModelClass.tableName, ['COUNT(1) AS count'], attributes);\n\n    return result.count;\n  }\n\n  static get modelMethods() {\n    return ['findFirst', 'findAll', 'findOrCreate', 'create', 'count'];\n  }\n\n  static get models() {\n    return models.slice();\n  }\n\n  static register(modelClass) {\n    models.push(modelClass);\n\n    PersistentObject.includeInto(modelClass);\n\n    const wrap = (method) => {\n      return function(...params) {\n        const args = [modelClass].concat(params);\n        return PersistentObject[method].apply(PersistentObject, args);\n      };\n    };\n\n    for (let method of PersistentObject.modelMethods) {\n      modelClass[method] = wrap(method);\n    }\n  }\n\n  updateFromDatabaseAttributes(attributes) {\n    this._updateFromDatabaseAttributes(attributes);\n  }\n\n  _updateFromDatabaseAttributes(attributes) {\n    for (const column of this.constructor.columns) {\n      const name = '_' + column.name;\n      const value = attributes[column.column];\n\n      // if (value == null && column[2] && column[2].null === false) {\n      //   console.warn(format('column %s cannot be null', name));\n      // }\n\n      this[name] = this.db.fromDatabase(value, column);\n    }\n\n    this._rowID = this.toNumber(attributes.id);\n  }\n\n  get databaseValues() {\n    const values = {};\n\n    for (const column of this.constructor.columns) {\n      const name = column.name;\n      const value = this['_' + name];\n\n      if (value == null && column.null === false) {\n        throw Error(format('column %s cannot be null', name));\n      }\n\n      values[column.column] = this.db.toDatabase(value, column);\n    }\n\n    return values;\n  }\n\n  get changes() {\n    return this.databaseValues;\n  }\n\n  toNumber(integer) {\n    return integer != null ? +integer : null;\n  }\n\n  updateTimestamps() {\n    const now = new Date();\n\n    if (!this.createdAt) {\n      this.createdAt = now;\n    }\n\n    this.updatedAt = now;\n  }\n\n  get isPersisted() {\n    return this.rowID > 0;\n  }\n\n  async save(options) {\n    options = options || {};\n\n    if (this.beforeSave) {\n      await this.beforeSave(options);\n    }\n\n    const values = this.databaseValues;\n\n    if (options.timestamps !== false) {\n      this.updateTimestamps();\n    }\n\n    values.created_at = this.db.toDatabase(this.createdAt, {type: 'datetime'});\n    values.updated_at = this.db.toDatabase(this.updatedAt, {type: 'datetime'});\n\n    if (!this.isPersisted) {\n      this._rowID = await this.db.insert(this.constructor.tableName, values, {pk: 'id'});\n    } else {\n      await this.db.update(this.constructor.tableName, {id: this.rowID}, values);\n    }\n\n    // It's not possible to override `async` methods currently (and be able to use `super`)\n    if (this.afterSave) {\n      await this.afterSave(options);\n    }\n\n    return this;\n  }\n\n  async delete(options) {\n    options = options || {};\n\n    if (this.isPersisted) {\n      await this.db.delete(this.constructor.tableName, {id: this.rowID});\n\n      this._rowID = null;\n      this.createdAt = null;\n      this.updatedAt = null;\n    }\n\n    return this;\n  }\n\n  async loadOne(name, model, id) {\n    const ivar = '_' + name;\n\n    if (this[ivar]) {\n      return this[ivar];\n    }\n\n    this[ivar] = await model.findFirst(this.db, {id: id || this[ivar + 'RowID']});\n\n    return this[ivar];\n  }\n\n  setOne(name, instance) {\n    const ivar = '_' + name;\n\n    if (instance) {\n      this[ivar] = instance;\n      this[ivar + 'RowID'] = instance.rowID;\n    } else {\n      this[ivar] = null;\n      this[ivar + 'RowID'] = null;\n    }\n  }\n}\n"]}