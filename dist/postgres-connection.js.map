{"version":3,"sources":["../src/postgres-connection.js"],"names":[],"mappings":";;;;;;;;;;;;;8BAQA,WAAkC,UAAlC,EAA8C;AAC5C,QAAI,OAAO,MAAM,UAAN,CAAX;;AAEA,QAAI,QAAQ,IAAZ,EAAkB;AAChB,YAAM,SAAS;AACb,YAAI,UADS;AAEb,aAAK,EAFQ;AAGb,2BAAmB,mBAAmB,iBAHzB;AAIb,4BAAoB,mBAAmB;AAJ1B,OAAf;;AAOA,aAAO,MAAM,UAAN,IAAoB,wBAAW,MAAX,CAA3B;AACD;;AAED,WAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACtC,WAAK,OAAL,CAAa,UAAC,GAAD,EAAM,MAAN,EAAiB;AAC5B,YAAI,GAAJ,EAAS;AACP,iBAAO,GAAP;AACA;AACD;;;AAGD,cAAM,SAAS;AACb,qBAAW,MADE;;AAGb,eAHa,mBAGL;AACN,kBAAM,SAAS,OAAO,KAAP,CAAa,KAAb,CAAmB,MAAnB,EAA2B,SAA3B,CAAf;;AAEA,kBAAM,MAAM;AACV,0BAAY,KADF;;AAGJ,kBAHI,kBAGG;AAAA;AACX,yBAAO,IAAI,OAAJ,CAAY,UAAC,GAAD,EAAM,GAAN,EAAc;AAC/B,2BAAO,IAAP,CAAY,UAAC,GAAD,EAAM,QAAN,EAAgB,OAAhB,EAAyB,MAAzB,EAAiC,KAAjC,EAA2C;AACrD,0BAAI,UAAJ,GAAiB,QAAjB;;AAEA,0BAAI,GAAJ,EAAS;AACP,+BAAO,IAAI,GAAJ,CAAP;AACD;;AAED,6BAAO,IAAI,EAAC,SAAS,OAAV,EAAmB,QAAQ,MAA3B,EAAJ,CAAP;AACD,qBARD;AASD,mBAVM,CAAP;AADW;AAYZ,eAfS;AAiBJ,mBAjBI,mBAiBI;AAAA;;AAAA;;AAEZ,yBAAO,CAAC,OAAO,QAAf,EAAyB;AACvB,wBAAI;AACF,4BAAM,MAAK,IAAL,EAAN;AACD,qBAFD,CAEE,OAAO,EAAP,EAAW;AACX,8BAAQ,IAAR,CAAa,gCAAb,EAA+C,EAA/C;AACD;AACF;AARW;AASb;AA1BS,aAAZ;;AA6BA,mBAAO,GAAP;AACD,WApCY;AAsCP,cAtCO,kBAsCA;AAAA;AACX,mBAAK,OAAL,CAAa,MAAb;AADW;AAEZ;AAxCY,SAAf;;AA2CA,gBAAQ,MAAR;AACD,OAnDD;AAoDD,KArDM,CAAP;AAsDD,G;;kBApEc,kB;;;;;AARf;;;;AAEA,MAAM,QAAQ,EAAd;;AA4EA,mBAAmB,QAAnB,GAA8B,MAAM;AAClC,OAAK,MAAM,UAAX,IAAyB,OAAO,IAAP,CAAY,KAAZ,CAAzB,EAA6C;AAC3C,UAAM,OAAO,MAAM,UAAN,CAAb;;AAEA,QAAI,IAAJ,EAAU;AACR,WAAK,KAAL,CAAW,MAAM;AACf,aAAK,aAAL;AACD,OAFD;AAGD;AACF;AACF,CAVD;;AAYA,mBAAmB,iBAAnB,GAAuC,IAAvC;AACA,mBAAmB,kBAAnB,GAAwC,IAAxC;;kBAEe,kB","file":"postgres-connection.js","sourcesContent":["import { createPool } from 'minipg';\n\nconst pools = {};\n\n// Wrap a single connection w/ a query method in an async function.\n// This is used when we need to execute multiple successive queries and make sure\n// they're executed on the *same* connection and not separate connections\n// from the connection pool.\nasync function postgresConnection(connection) {\n  let pool = pools[connection];\n\n  if (pool == null) {\n    const params = {\n      db: connection,\n      max: 25,\n      idleTimeoutMillis: postgresConnection.idleTimeoutMillis,\n      reapIntervalMillis: postgresConnection.reapIntervalMillis\n    };\n\n    pool = pools[connection] = createPool(params);\n  }\n\n  return new Promise((resolve, reject) => {\n    pool.acquire((err, client) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n\n      // return a little object with a query method and a done method\n      const result = {\n        rawClient: client,\n\n        query() {\n          const cursor = client.query.apply(client, arguments);\n\n          const obj = {\n            isFinished: false,\n\n            async next() {\n              return new Promise((res, rej) => {\n                cursor.next((err, finished, columns, values, index) => {\n                  obj.isFinished = finished;\n\n                  if (err) {\n                    return rej(err);\n                  }\n\n                  return res({columns: columns, values: values});\n                });\n              });\n            },\n\n            async close() {\n              // exhaust the cursor to completion\n              while (!cursor.finished) {\n                try {\n                  await this.next();\n                } catch (ex) {\n                  console.warn('exception while closing cursor', ex);\n                }\n              }\n            }\n          };\n\n          return obj;\n        },\n\n        async done() {\n          pool.release(client);\n        }\n      };\n\n      resolve(result);\n    });\n  });\n}\n\npostgresConnection.shutdown = () => {\n  for (const connection of Object.keys(pools)) {\n    const pool = pools[connection];\n\n    if (pool) {\n      pool.drain(() => {\n        pool.destroyAllNow();\n      });\n    }\n  }\n};\n\npostgresConnection.idleTimeoutMillis = null;\npostgresConnection.reapIntervalMillis = null;\n\nexport default postgresConnection;\n"]}